delete from CHITIETHOADON;
delete from HOADONBANHANG;


DECLARE @Year INT = 2025;
DECLARE @i INT = 1;
DECLARE @MANV varchar(6);
DECLARE @MAKH varchar(6);
DECLARE @MAGIAM varchar(30);
DECLARE @GIAMGIA int;
DECLARE @HTTT BIT;

WHILE @i <= 100
BEGIN
    DECLARE @Month INT = FLOOR(RAND() * 12) + 1;       
    DECLARE @Day INT = FLOOR(RAND() * 28) + 1;        
    DECLARE @Ngay DATE = DATEFROMPARTS(@Year, @Month, @Day);
	SET @MANV = (SELECT TOP 1 MANV FROM NHANVIEN ORDER BY NEWID());
	SET @MAKH = (SELECT TOP 1 MAKH FROM KHACHHANG ORDER BY NEWID());
	SET @MAGIAM = (SELECT TOP 1 MAGIAM FROM MAGIAMGIA ORDER BY NEWID());
	SET @GIAMGIA = (SELECT TOP 1 GIAMGIA FROM MAGIAMGIA where MAGIAM = @MAGIAM) + (SELECT TOP 1 GIAMGIA FROM LOAIKHACHHANG lkh join KHACHHANG kh on lkh.MALKH = kh.MALKH where kh.MAKH = @MAKH) ;
	SET @HTTT = CAST(ROUND(RAND(), 0) AS BIT);

    INSERT INTO HOADONBANHANG (MANV, MAKH, NGAYHDBH, MAGIAM, GIAMGIA,HINHTHUCTHANHTOAN)
    VALUES (@MANV, @MAKH, @Ngay, @MAGIAM, @GIAMGIA,@HTTT);

    DECLARE @MaHDBH VARCHAR(10) = (SELECT TOP 1 MAHDBH FROM HOADONBANHANG WHERE TONGTIEN IS NULL ORDER BY NGAYHDBH DESC);

    DECLARE @j INT = 1;
    WHILE @j <= 3
    BEGIN
        DECLARE @MaHH VARCHAR(10), @GiaSP DECIMAL(18,2), @SoLuong INT;

        SET @MaHH = (SELECT TOP 1 MaHH FROM HANGHOA ORDER BY NEWID());
        IF @MaHH IS NOT NULL
        BEGIN
            SET @GiaSP = (SELECT TOP 1 GIASP FROM HANGHOA WHERE MAHH = @MaHH);
            SET @SoLuong = 1 + (ABS(CHECKSUM(NEWID()) % 5));

            INSERT INTO CHITIETHOADON (MAHDBH, MAHH, SOLUONG, THANHTIEN)
            VALUES (@MaHDBH, @MaHH, @SoLuong, @GiaSP * @SoLuong);

			UPDATE HOADONBANHANG
			SET TONGTIEN = (SELECT SUM(THANHTIEN) FROM CHITIETHOADON WHERE MAHDBH = @MaHDBH) 
						   * (1 - (CAST(GIAMGIA AS FLOAT) / 100.0))
			WHERE MAHDBH = @MaHDBH;

			UPDATE HOADONBANHANG
            SET DIEMTL = TONGTIEN * 0.0001
            WHERE MAHDBH = @MaHDBH;
        END

        SET @j = @j + 1;
    END

    SET @i = @i + 1;
END

